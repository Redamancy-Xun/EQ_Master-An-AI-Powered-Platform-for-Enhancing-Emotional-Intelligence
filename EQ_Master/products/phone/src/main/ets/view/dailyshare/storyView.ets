import { dailyShareToStoryDataConverter } from "../../model/Converter"
import { DailyShare, stance, storyData } from "../../server/dailyshare/DailyShareData"


@Entry
@Component
export struct DailyShareStory {
  @Prop Story:storyData = Object()
  @State selectedStance:number = -1 // ç”¨äºé€‰æ‹©æ”¯æŒé¡¹æ—¶çš„åŠ¨æ€é¢œè‰²å˜åŒ–
  @State selectedEmoji:number = -1 //ç”¨äºé€‰æ‹©æƒ…ç»ªè¡¨æƒ…æ—¶çš„åŠ¨æ€é¢œè‰²å˜åŒ–
  @State emojiPopup: boolean = false

  private emojiList:Array<string> = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…','ğŸ˜‚', 'ğŸ¤£']
  private converter:dailyShareToStoryDataConverter = new dailyShareToStoryDataConverter()
  private s1:DailyShare = {
  id: "story-1",
  createdAt: "2025-01-05 15:32:23",
  updatedAt: "",
  isLike: false,
  isStar: false,
  isShare: false,
  type: "story",
  title: "ä¹”æ²»å·§åº”ç»“å©šé—®é¢˜",
  context: "åœ¨ä¸€æ¬¡é‡‡è®¿ä¸­ï¼Œè®°è€…é—®ä»–ï¼šâ€œä½ å·²ç»40å¤šå²äº†ï¼Œä¸ºä»€ä¹ˆè¿˜ä¸ç»“å©šï¼Ÿâ€è¿™ä¸ªé—®é¢˜å¾ˆå®¹æ˜“è®©äººæ„Ÿåˆ°å°´å°¬ï¼Œä½†ä¹”æ²»Â·å…‹é²å°¼å›ç­”å¾—æ—¢å¹½é»˜åˆçœŸè¯šï¼šâ€œæˆ‘ä¸€ç›´åœ¨ç­‰å¾…ä¸€ä¸ªåƒæˆ‘ä¸€æ ·æœ‰é­…åŠ›çš„äººå‡ºç°ã€‚â€ä»–ç”¨å¹½é»˜åŒ–è§£äº†å°´å°¬ï¼ŒåŒæ—¶ä¹Ÿè¡¨è¾¾äº†è‡ªå·±å¯¹å©šå§»çš„è®¤çœŸæ€åº¦ã€‚",
  picture: "story1.jpg",
  likes: 0,
  view: 0,
  commentCount: 0,
  favorite: 0,
  share: 0
  }
  private st1:stance = new stance('ä½ å¥½ä½ å¥½ä½ å¥½ä½ å¥½ä½ å¥½å¥½'
    ,0,0)

  initTest(){
    this.Story = this.converter.convert(this.s1)
    this.st1.addParticipant('1')
    this.Story.setStances(this.st1)
    this.Story.setStances(this.st1)
    this.Story.setStances(this.st1)
    this.Story.setStances(this.st1)
  }

  loadParticipantImage(){

  }

  aboutToAppear(): void {
    this.initTest()
  }

  @Builder
  emojiOption(index:number){
    Row({space:10}){
      Text(this.emojiList[index])
        .fontSize(20)
      Text(this.Story.mood[index].toString())
        .fontSize(13)
    }
    .width('21%')
    .borderRadius(5)
    .onClick(()=>{
      this.selectedEmoji = index
    })
    .backgroundColor(this.selectedEmoji == index?'#a9c0ff':'#f5f2f2')
    .margin(5)
  }

  @Builder
  popupBuilder(){
    Column(){
      Row(){
        ForEach(this.emojiList.slice(0,5),(item:string,index:number)=>{
          Text(item)
            .fontSize(13)
            .margin(5)
        })
      }
      Row(){
        ForEach(this.emojiList.slice(5,8),(item:string,index:number)=>{
          Text(item)
            .fontSize(13)
            .margin(5)
        })
      }
    }
    .margin(5)
  }

  @Builder
  stanceArea(instance:stance,index:number){ // æ”¯æŒ/åå¯¹é€‰é¡¹
    Row(){ // æœ€å¤–ä¾§èƒŒæ™¯å’Œè¾¹è§’
      Row(){ //å†…å®¹
        Text(instance.content)
          .maxLines(3)
          .width('75%')
          .height('46vp')
          .fontSize(13)
          .textOverflow({overflow:TextOverflow.Ellipsis})
        Row(){ //å‚ä¸æ´»åŠ¨çš„ç”¨æˆ·å¤´åƒ
          ForEach(instance.participant,(item:string)=>{
            Image($r(item))
              .height('75px')
              .width('75px')
              .objectFit(ImageFit.Cover)
          })
        }
        Row(){
          Image($r('app.media.like'))
            .height('20vp')
            .aspectRatio(1)
          Text(instance.support.toString())
            .fontSize(8)
        }
      }
      .onClick(()=>{
        this.selectedStance = index
      })
      .padding({left:5,right:5,top:5,bottom:5})
    }
    .backgroundColor(this.selectedStance == index?'#d0dcff':Color.White)
    .borderRadius(15)
  }

  build() {
    Column(){
      Row({space:0}){
        Image(this.Story.icon) // ç”¨æˆ·å¤´åƒ?ç³»ç»Ÿé»˜è®¤å¤´åƒ
          .height('150px')
          .width('150px')
          .borderRadius(30)
          .margin({top:5})
          .objectFit(ImageFit.Cover)
        Column(){ //å³è¾¹
          Column(){ // å³è¾¹æ•…äº‹å†…å®¹çš„èƒŒæ™¯
            Column({space:5}){ //æ•…äº‹å†…å®¹,ä¸ºäº†å¯¹é½
              Text(this.Story.title)
                .fontWeight(FontWeight.Bold)
                .maxLines(1)
                .textOverflow({overflow:TextOverflow.Ellipsis})
                .fontSize(18)
              Text(this.Story.content)
                .maxLines(10)
                .fontSize(13)
                .textOverflow({overflow:TextOverflow.Ellipsis})
              Column({space:10}) {
                ForEach(this.Story.interaction, (item: stance,index:number) => {
                  this.stanceArea(item,index)
                })
              }
            }
            .margin({left:15,right:15,top:5,bottom:15})
            .alignItems(HorizontalAlign.Start)
          }
          .margin(5)
          .backgroundColor('#edf2ff')
          .borderRadius(10)
          .width('80%')
          .shadow({ // é˜´å½±
            radius: 4,
            color: Color.Gray,
            offsetY: 3,
          })

          Column(){
            Row(){ // è¡¨æƒ…ç¬¦å·åŒºåŸŸ
              ForEach(this.emojiList.slice(0,4),(item:string,index:number)=>{
                this.emojiOption(index)
              })
            }
            Row(){ // è¡¨æƒ…ç¬¦å·åŒºåŸŸ, ä¸¤ä¸ªç»“æ„å®Œå…¨ä¸€æ ·
              ForEach(this.emojiList.slice(4,8),(item:string,index:number)=>{
                this.emojiOption(index+4)
              })
            }
            Image($r('app.media.ic_public_add_norm'))
              .height(30)
              .alignSelf(ItemAlign.End)
              .onClick(()=>{
                this.emojiPopup = !this.emojiPopup
              })
              .bindPopup(this.emojiPopup, {
                builder: this.popupBuilder, // æ°”æ³¡çš„å†…å®¹
                placement:Placement.Bottom, // æ°”æ³¡çš„å¼¹å‡ºä½ç½®
                popupColor:Color.Pink, // æ°”æ³¡çš„èƒŒæ™¯è‰²
                onStateChange: (e) => {
                  if (!e.isVisible) {
                    this.emojiPopup = false
                  }
                }
              })
          }
          .margin({left:5,right:15,top:5,bottom:15})
          .alignItems(HorizontalAlign.Start)
          .width('80%')
        }
        .alignItems(HorizontalAlign.Start)

      }
      .margin(5)
      .alignItems(VerticalAlign.Top)

    }

  }
}